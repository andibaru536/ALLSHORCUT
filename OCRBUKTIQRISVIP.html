<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SHORTCUT VIP - Ekstraktor Bukti Transfer</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
:root {
  --primary: #4361ee;
  --secondary: #3a0ca3;
  --accent: #f72585;
  --text: #212529;
  --text-light: #f8f9fa;
  --bg: #f8f9fa;
  --card-bg: #ffffff;
  --card-shadow: rgba(0, 0, 0, 0.1);
  --input-bg: #ffffff;
  --border: #dee2e6;
  --success: #4caf50;
  --error: #f44336;
  --warning: #ff9800;
  --info: #2196f3;
  --progress-bg: #e9ecef;
  --progress-bar: #4361ee;
  --dark-bg: #121212;
  --dark-card: #1e1e1e;
  --dark-text: #e0e0e0;
  --dark-border: #333333;
  --dark-input: #2d2d2d;
  --dark-shadow: rgba(0, 0, 0, 0.4);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  transition: background-color 0.3s, color 0.3s;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
              url('https://cdn.areabermain.club/assets/cdn/az6/2025/07/31/20250731/eeb91f9b1f7b3247242ccba997460e8b/linetogel-bg-17agustus2025.jpg') no-repeat center center fixed;
  background-size: cover;
  min-height: 100vh;
  padding: 20px;
  color: var(--text-light);
}

body.dark-mode {
  background: linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), 
              url('https://cdn.areabermain.club/assets/cdn/az6/2025/07/31/20250731/eeb91f9b1f7b3247242ccba997460e8b/linetogel-bg-17agustus2025.jpg') no-repeat center center fixed;
  background-size: cover;
  color: var(--dark-text);
}

.container {
  max-width: 800px;
  margin: 0 auto;
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.header-content {
  flex-grow: 1;
}

h1 {
  font-size: 2.2rem;
  color: white;
  text-align: center;
  margin-bottom: 10px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

h1 i {
  background: linear-gradient(45deg, var(--accent), var(--primary));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.card {
  background-color: rgba(255, 255, 255, 0.9);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  margin-bottom: 25px;
  border: 1px solid var(--border);
  backdrop-filter: blur(5px);
}

body.dark-mode .card {
  background-color: rgba(30, 30, 30, 0.85);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  border-color: var(--dark-border);
}

.form-group {
  margin-bottom: 20px;
  position: relative;
}

label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: var(--primary);
  font-size: 1rem;
}

body.dark-mode label {
  color: #bb86fc;
}

.input-container {
  position: relative;
}

input, select {
  width: 100%;
  padding: 12px 45px 12px 15px;
  border: 2px solid var(--border);
  border-radius: 10px;
  font-size: 15px;
  background-color: var(--input-bg);
  transition: all 0.3s;
  box-sizing: border-box;
}

body.dark-mode input, 
body.dark-mode select {
  background-color: var(--dark-input);
  border-color: var(--dark-border);
  color: var(--dark-text);
}

input:focus, select:focus {
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
  outline: none;
}

.clear-btn {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: #777;
  cursor: pointer;
  font-size: 16px;
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
}

.clear-btn:hover {
  background-color: #f0f0f0;
  color: #ff4d4d;
}

body.dark-mode .clear-btn:hover {
  background-color: #333;
}

/* PERUBAHAN: Unggah gambar diperkecil */
.upload-container {
  border: 2px dashed var(--border);
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  cursor: pointer;
  margin-top: 12px;
  transition: all 0.3s;
  background-color: rgba(255, 255, 255, 0.8);
}

body.dark-mode .upload-container {
  border-color: var(--dark-border);
  background-color: rgba(45, 45, 45, 0.6);
}

.upload-container:hover {
  border-color: var(--primary);
  background-color: rgba(67, 97, 238, 0.1);
}

.upload-container i {
  font-size: 28px;
  color: var(--primary);
  margin-bottom: 6px;
}

.upload-container p {
  font-size: 13px;
  color: #666;
  margin-bottom: 4px;
}

body.dark-mode .upload-container p {
  color: #aaa;
}

.upload-container span {
  font-size: 11px;
  color: #999;
}

/* Preview Container */
#preview-container {
  margin-top: 20px;
  text-align: center;
  border-radius: 10px;
  overflow: hidden;
  max-width: 100%;
  display: none;
  position: relative;
}

#preview {
  max-width: 100%;
  max-height: 180px;
  border-radius: 8px;
  background-color: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  cursor: pointer;
  transition: transform 0.3s;
}

body.dark-mode #preview {
  background-color: #2d2d2d;
}

.preview-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.3s;
  border-radius: 8px;
}

#preview-container:hover .preview-overlay {
  opacity: 1;
}

.preview-overlay i {
  font-size: 40px;
  color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.result {
  margin-top: 30px;
  padding: 20px;
  background-color: rgba(255, 255, 255, 0.9);
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease;
  border-left: 4px solid var(--primary);
  backdrop-filter: blur(5px);
}

body.dark-mode .result {
  background-color: rgba(30, 30, 30, 0.85);
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
}

.result:hover {
  transform: translateY(-3px);
}

.result h3 {
  color: var(--primary);
  margin-top: 0;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.4rem;
}

body.dark-mode .result h3 {
  border-color: var(--dark-border);
}

/* PERUBAHAN: Layout vertikal untuk hasil */
.result-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.result-item {
  margin-bottom: 0;
}

.result-label {
  font-weight: 600;
  color: var(--primary);
  display: block;
  margin-bottom: 6px;
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

.result-value {
  background-color: rgba(67, 97, 238, 0.08);
  padding: 12px 15px;
  border-radius: 10px;
  font-size: 16px;
  border: 1px solid rgba(67, 97, 238, 0.2);
  display: flex;
  justify-content: space-between;
  align-items: center;
  min-height: 50px;
}

body.dark-mode .result-value {
  background-color: rgba(67, 97, 238, 0.15);
  border-color: rgba(67, 97, 238, 0.3);
}

.copy-btn {
  background: none;
  border: none;
  color: var(--primary);
  cursor: pointer;
  padding: 8px;
  font-size: 16px;
  border-radius: 8px;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 34px;
  height: 34px;
}

.copy-btn:hover {
  background-color: rgba(67, 97, 238, 0.1);
  transform: scale(1.1);
}

body.dark-mode .copy-btn {
  color: #bb86fc;
}

body.dark-mode .copy-btn:hover {
  background-color: rgba(187, 134, 252, 0.1);
}

#loading {
  text-align: center;
  margin: 20px 0;
  display: none;
  background-color: rgba(255, 255, 255, 0.9);
  padding: 18px;
  border-radius: 12px;
  border: 1px solid var(--border);
  backdrop-filter: blur(5px);
}

body.dark-mode #loading {
  background-color: rgba(30, 30, 30, 0.85);
  border-color: var(--dark-border);
}

.copy-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--success);
  color: white;
  padding: 12px 20px;
  border-radius: 8px;
  z-index: 1000;
  box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  gap: 10px;
  opacity: 0;
  transform: translateY(-20px);
  transition: opacity 0.3s, transform 0.3s;
}

.copy-notification.show {
  opacity: 1;
  transform: translateY(0);
}

.copy-notification i {
  font-size: 18px;
}

.progress-container {
  width: 100%;
  height: 7px;
  background-color: var(--progress-bg);
  border-radius: 4px;
  margin-top: 12px;
  overflow: hidden;
}

body.dark-mode .progress-container {
  background-color: #333;
}

.progress-bar {
  height: 100%;
  background: linear-gradient(to right, var(--primary), var(--accent));
  border-radius: 4px;
  width: 0%;
  transition: width 0.3s ease;
}

.action-buttons {
  display: flex;
  gap: 12px;
  margin-top: 18px;
}

.btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.btn-primary {
  background: linear-gradient(to right, var(--primary), var(--secondary));
  color: white;
  box-shadow: 0 4px 8px rgba(67, 97, 238, 0.25);
}

.btn-primary:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(67, 97, 238, 0.35);
}

.btn-secondary {
  background: rgba(0, 0, 0, 0.05);
  color: var(--text);
  border: 1px solid var(--border);
  box-shadow: 0 4px 8px rgba(0,0,0,0.05);
}

body.dark-mode .btn-secondary {
  background: rgba(255, 255, 255, 0.05);
  color: var(--dark-text);
  border-color: var(--dark-border);
}

.btn-secondary:hover {
  background: rgba(0, 0, 0, 0.1);
}

body.dark-mode .btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
}

.theme-toggle {
  background: rgba(255, 255, 255, 0.25);
  border: none;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  color: white;
  font-size: 18px;
  transition: all 0.3s;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.theme-toggle:hover {
  background: rgba(255, 255, 255, 0.35);
  transform: rotate(15deg);
}

/* Preview Image Modal */
#imagePreviewModal {
  display: none;
  position: fixed;
  z-index: 1000;
  padding-top: 50px;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.9);
}

#imagePreviewModal img {
  margin: auto;
  display: block;
  max-width: 80%;
  max-height: 80%;
  border: 3px solid white;
  border-radius: 8px;
  box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

#closePreview {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  transition: 0.3s;
  cursor: pointer;
  text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

#closePreview:hover,
#closePreview:focus {
  color: #bbb;
  text-decoration: none;
}

/* Animasi salin */
@keyframes copyPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.copy-success {
  animation: copyPulse 0.5s ease;
}

@media (max-width: 600px) {
  .container {
    padding: 10px;
  }
  
  .card {
    padding: 18px;
  }
  
  h1 {
    font-size: 1.8rem;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  #imagePreviewModal img {
    max-width: 95%;
  }
  
  .copy-notification {
    left: 20px;
    right: 20px;
    top: 10px;
    text-align: center;
  }
  
  .header {
    flex-direction: column;
    gap: 15px;
  }
  
  .theme-toggle {
    position: absolute;
    top: 15px;
    right: 15px;
  }
  
  .result-value {
    padding: 10px 12px;
    font-size: 15px;
    min-height: 46px;
  }
  
  .btn {
    padding: 10px;
    font-size: 14px;
  }
}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-content">
      <h1><i class="fas fa-bolt"></i> SHORTCUT VIP</h1>
      <p style="text-align: center; color: #4361ee; font-weight: 500; margin-top: 5px;">Ekstraktor Bukti Transfer DANA, BRI & BCA</p>
    </div>
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-moon"></i>
    </button>
  </div>

  <div class="card">
    <div class="form-group">
      <label for="userId"><i class="fas fa-user"></i> User ID:</label>
      <div class="input-container">
        <input type="text" id="userId" placeholder="Masukkan User ID">
        <button class="clear-btn" id="clearUserId">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="form-group">
      <label for="imageUrl"><i class="fas fa-link"></i> URL Gambar Bukti:</label>
      <div class="input-container">
        <input type="text" id="imageUrl" placeholder="Tempel URL gambar bukti transfer">
        <button class="clear-btn" id="clearImageUrl">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>

    <div class="upload-container" id="uploadContainer">
      <i class="fas fa-cloud-upload-alt"></i>
      <p>Unggah Gambar Bukti Transfer</p>
      <span>Klik untuk memilih file (JPG, PNG, maks 5MB)</span>
      <input type="file" id="fileInput" accept="image/*" style="display: none;">
    </div>

    <div class="form-group">
      <label for="bankSelect"><i class="fas fa-university"></i> Pilih Jenis Bank:</label>
      <select id="bankSelect">
        <option value="DANA">DANA</option>
        <option value="BRI">BRI</option>
        <option value="BCA">BCA</option>
        <option value="BNI">BNI</option>
        <option value="MANDIRI">Mandiri</option>
      </select>
    </div>

    <!-- Preview Container -->
    <div id="preview-container">
      <img id="preview" alt="Preview Gambar">
      <div class="preview-overlay">
        <i class="fas fa-search-plus"></i>
      </div>
    </div>

    <div class="action-buttons">
      <button id="processButton" class="btn btn-primary">
        <i class="fas fa-cogs"></i> Proses Gambar
      </button>
      <button id="resetButton" class="btn btn-secondary">
        <i class="fas fa-redo"></i> Reset Form
      </button>
    </div>

    <div id="loading">
      <p><i class="fas fa-sync fa-spin"></i> Sedang memproses gambar... Harap tunggu</p>
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <p id="progressStatus">Menginisialisasi...</p>
    </div>
  </div>

  <div class="card result" id="results">
    <h3><i class="fas fa-file-invoice"></i> Hasil Ekstraksi</h3>
    <div class="result-list">
      <!-- Urutan vertikal: Merchant, RRN, Total, User ID, Jenis Bank -->
      <div class="result-item">
        <span class="result-label"><i class="fas fa-store"></i> Nama Merchant/Toko:</span>
        <div class="result-value">
          <span id="merchantName">-</span>
          <button class="copy-btn" onclick="copyToClipboard('merchantName')">
            <i class="far fa-copy"></i>
          </button>
        </div>
      </div>
      <div class="result-item">
        <span class="result-label"><i class="fas fa-hashtag"></i> Nomor Referensi (RRN):</span>
        <div class="result-value">
          <span id="rrn">-</span>
          <button class="copy-btn" onclick="copyToClipboard('rrn')">
            <i class="far fa-copy"></i>
          </button>
        </div>
      </div>
      <div class="result-item">
        <span class="result-label"><i class="fas fa-money-bill-wave"></i> Total:</span>
        <div class="result-value">
          <span id="totalAmount">-</span>
          <button class="copy-btn" onclick="copyToClipboard('totalAmount')">
            <i class="far fa-copy"></i>
          </button>
        </div>
      </div>
      <div class="result-item">
        <span class="result-label"><i class="fas fa-user"></i> User ID:</span>
        <div class="result-value">
          <span id="resultUserId">-</span>
          <button class="copy-btn" onclick="copyToClipboard('resultUserId')">
            <i class="far fa-copy"></i>
          </button>
        </div>
      </div>
      <div class="result-item">
        <span class="result-label"><i class="fas fa-landmark"></i> Jenis Bank:</span>
        <div class="result-value">
          <span id="selectedBank">-</span>
          <button class="copy-btn" onclick="copyToClipboard('selectedBank')">
            <i class="far fa-copy"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal untuk preview gambar -->
<div id="imagePreviewModal">
  <span id="closePreview">&times;</span>
  <img id="previewImage" alt="Bukti Transfer">
</div>

<div class="copy-notification" id="copyNotification">
  <i class="fas fa-check-circle"></i> <span id="notificationText">Teks telah disalin!</span>
</div>

<script>
// Inisialisasi variabel
let currentProcessId = 0;
let isProcessing = false;
let uploadedImageUrl = null;
let currentImageUrl = null; // Untuk menyimpan URL gambar yang diproses

// Fungsi untuk memvalidasi URL gambar
function isValidImageUrl(url) {
  return /\.(jpe?g|png|gif|bmp|webp)$/i.test(url) || 
         /^https?:\/\/.+(?:jpe?g|png|gif|bmp|webp)/i.test(url) ||
         url.startsWith('data:image');
}

// Fungsi untuk membersihkan angka (hapus karakter non-digit)
function cleanNumber(text) {
  return text.replace(/[^\d]/g, '');
}

// Fungsi untuk memformat mata uang
function formatCurrency(amount) {
  return 'Rp ' + parseInt(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

// Fungsi untuk menampilkan notifikasi
function showNotification(message, isError = false) {
  const notification = document.getElementById('copyNotification');
  const notificationText = document.getElementById('notificationText');
  
  if (isError) {
    notification.style.background = 'var(--error)';
    notificationText.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${message}`;
  } else {
    notification.style.background = 'var(--success)';
    notificationText.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
  }
  
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

// Fungsi untuk memproses nominal (hilangkan koma dan desimal)
function processAmount(amountStr) {
  // Hapus semua titik (ribuan separator)
  let cleaned = amountStr.replace(/\./g, '');
  // Hapus koma dan angka setelahnya (desimal)
  cleaned = cleaned.replace(/,.*$/, '');
  // Hapus karakter non-digit yang tersisa
  return cleaned.replace(/\D/g, '');
}

// Fungsi utama untuk memproses gambar
async function processImage() {
  let imageUrl = document.getElementById('imageUrl').value;
  
  // Gunakan gambar yang diupload jika ada
  if (!imageUrl && uploadedImageUrl) {
    imageUrl = uploadedImageUrl;
  }
  
  const userId = document.getElementById('userId').value;
  const bankSelect = document.getElementById('bankSelect');
  const loading = document.getElementById('loading');
  const progressBar = document.getElementById('progressBar');
  const progressStatus = document.getElementById('progressStatus');
  const previewContainer = document.getElementById('preview-container');
  const preview = document.getElementById('preview');

  // Validasi input
  if (!imageUrl) {
    showNotification('Silakan masukkan URL gambar atau unggah gambar terlebih dahulu', true);
    return;
  }

  if (!userId) {
    showNotification('Silakan masukkan User ID terlebih dahulu', true);
    return;
  }

  if (!isValidImageUrl(imageUrl)) {
    showNotification('URL gambar tidak valid. Pastikan URL berakhir dengan ekstensi gambar (.jpg, .png, dll)', true);
    return;
  }

  // Simpan gambar yang diproses
  currentImageUrl = imageUrl;
  
  // Tampilkan preview gambar
  if (preview) {
    preview.src = imageUrl;
    previewContainer.style.display = 'block';
  }
  
  // Set status pemrosesan
  isProcessing = true;
  const processId = ++currentProcessId;

  loading.style.display = 'block';
  if (progressBar) progressBar.style.width = '0%';
  if (progressStatus) progressStatus.textContent = 'Menginisialisasi...';

  try {
    const { data: { text } } = await Tesseract.recognize(
      imageUrl,
      'eng+ind',
      {
        logger: m => {
          if (processId !== currentProcessId) return;

          if (m.status === 'recognizing text') {
            const progress = Math.min(100, Math.round(m.progress * 100));
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (progressStatus) progressStatus.textContent = `Memproses: ${progress}%`;
          }
        }
      }
    );

    if (processId !== currentProcessId) return;

    extractDataFromText(text, bankSelect.value);
    if (document.getElementById('resultUserId')) {
      document.getElementById('resultUserId').textContent = userId;
    }
    if (document.getElementById('selectedBank')) {
      document.getElementById('selectedBank').textContent = bankSelect.value;
    }

    showNotification('Gambar berhasil diproses!');

  } catch (error) {
    if (processId !== currentProcessId) return;

    console.error('Error processing image:', error);
    showNotification('Gagal memproses gambar: ' + error.message, true);
  } finally {
    if (processId !== currentProcessId) return;

    if (loading) loading.style.display = 'none';
    isProcessing = false;
  }
}

// Fungsi untuk mengekstrak data dari teks hasil OCR
function extractDataFromText(text, bankType) {
  let merchantName = 'Tidak ditemukan';
  let totalAmount = 'Tidak ditemukan';
  let rrn = 'Tidak ditemukan';

  console.log("Teks yang diekstrak dari gambar:", text);

  if (bankType === 'DANA') {
    const merchantMatch = text.match(/Pembayaran\s+ke\s+([^\n\u2022-]+)/i);
    const amountMatch = text.match(/(?:Total\s*Bayar|Total)\s*Rp\s*([\d.,]+)/i) ||
                       text.match(/Rp\s*([\d.,]+)(?=\s*(?:Dana|Bayar|Total))/i);
    const rrnQrisMatch = text.match(/RRN\s*QRIS\s*([^\s\n]+)/i);
    const rrnMatch = text.match(/RRN\s*[:]?\s*(\d+)/i) ||
                     text.match(/Ref\s*[:]?\s*(\d+)/i);

    merchantName = merchantMatch ? merchantMatch[1].trim() : merchantName;
    rrn = rrnQrisMatch ? rrnQrisMatch[1].trim() : (rrnMatch ? rrnMatch[1].trim() : rrn);

    if (amountMatch) {
      const amountValue = processAmount(amountMatch[1]);
      totalAmount = formatCurrency(amountValue);
      const totalElement = document.getElementById('totalAmount');
      if (totalElement) {
        totalElement.setAttribute('data-clean', amountValue);
        totalElement.textContent = totalAmount;
      }
    }

  } else if (bankType === 'BRI') {
    const merchantMatch = text.match(/Nama\s+Merchant\s+([^\n]+)/i);
    const amountMatch = text.match(/Nominal\s+Rp\s*([\d.,]+)/i) ||
                       text.match(/Total\s+Rp\s*([\d.,]+)/i);
    const rrnMatch = text.match(/Nomor\s+Referensi\s+(\d{6,})/i) ||
                     text.match(/RRN\s*[:]?\s*(\d+)/i);

    merchantName = merchantMatch ? merchantMatch[1].trim() : merchantName;
    rrn = rrnMatch ? rrnMatch[1].trim() : rrn;

    if (amountMatch) {
      const amountValue = processAmount(amountMatch[1]);
      totalAmount = formatCurrency(amountValue);
      const totalElement = document.getElementById('totalAmount');
      if (totalElement) {
        totalElement.setAttribute('data-clean', amountValue);
        totalElement.textContent = totalAmount;
      }
    }

  } else if (bankType === 'BCA') {
    const merchantMatch = text.match(/Merchant\s*[:]?\s*([^\n]+)/i) ||
                          text.match(/(.*STORE)/i);
    
    // PERBAIKAN KHUSUS UNTUK BCA: Ambil nominal yang tepat setelah "TOTAL PEMBAYARAN"
    // Mencari baris yang mengandung "TOTAL PEMBAYARAN" dan mengambil nilai di sampingnya
    const amountLineMatch = text.match(/TOTAL\s+PEMBAYARAN\s*[\s\S]*?Rp\s*([\d.,]+)/i);
    
    // Jika tidak ditemukan, coba pola alternatif
    const amountMatch = amountLineMatch || 
                       text.match(/TOTAL\s+BAYAR\s*[\s\S]*?Rp\s*([\d.,]+)/i) ||
                       text.match(/Rp\s*([\d.,]+)\s*(?:TOTAL|BAYAR)/i);

    merchantName = merchantMatch ? merchantMatch[1].trim() : merchantName;
    const rrnMatch = text.match(/RRN\s*[:]?\s*(\d{6,})/i) ||
                     text.match(/Ref\s*[:]?\s*(\d+)/i);
    rrn = rrnMatch ? rrnMatch[1].trim() : rrn;

    if (amountMatch) {
      // Proses nominal: hapus titik dan ambil hanya bagian sebelum koma (jika ada)
      const amountValue = processAmount(amountMatch[1]);
      totalAmount = formatCurrency(amountValue);
      const totalElement = document.getElementById('totalAmount');
      if (totalElement) {
        totalElement.setAttribute('data-clean', amountValue);
        totalElement.textContent = totalAmount;
      }
    }

  } else if (bankType === 'BNI') {
    const merchantMatch = text.match(/Nama\s+Merchant\s+([^\n]+)/i);
    const amountMatch = text.match(/Nominal\s+Bayar\s+Rp\s*([\d.]+)(?:,|$)/i) ||
                       text.match(/Total\s+Rp\s*([\d.]+)(?:,|$)/i);
    const rrnMatch = text.match(/Reff\s+ID\/RRN\s+([^\n]+)/i) ||
                     text.match(/RRN\s*[:]?\s*(\d+)/i);

    merchantName = merchantMatch ? merchantMatch[1].trim() : merchantName;
    rrn = rrnMatch ? rrnMatch[1].trim() : rrn;

    if (amountMatch) {
      const amountValue = processAmount(amountMatch[1]);
      totalAmount = formatCurrency(amountValue);
      const totalElement = document.getElementById('totalAmount');
      if (totalElement) {
        totalElement.setAttribute('data-clean', amountValue);
        totalElement.textContent = totalAmount;
      }
    }
  } else if (bankType === 'MANDIRI') {
    const merchantMatch = text.match(/Nama\s+Merchant\s+([^\n]+)/i);
    const amountMatch = text.match(/Nominal\s+Rp\s*([\d.,]+)/i) ||
                       text.match(/Total\s+Rp\s*([\d.,]+)/i);
    const rrnMatch = text.match(/Nomor\s+Referensi\s+(\d{6,})/i) ||
                     text.match(/RRN\s*[:]?\s*(\d+)/i);

    merchantName = merchantMatch ? merchantMatch[1].trim() : merchantName;
    rrn = rrnMatch ? rrnMatch[1].trim() : rrn;

    if (amountMatch) {
      const amountValue = processAmount(amountMatch[1]);
      totalAmount = formatCurrency(amountValue);
      const totalElement = document.getElementById('totalAmount');
      if (totalElement) {
        totalElement.setAttribute('data-clean', amountValue);
        totalElement.textContent = totalAmount;
      }
    }
  }

  // Update UI dengan hasil ekstraksi
  if (document.getElementById('merchantName')) {
    document.getElementById('merchantName').textContent = merchantName;
  }
  if (document.getElementById('rrn')) {
    document.getElementById('rrn').textContent = rrn;
  }
}

// Fungsi untuk menyalin teks ke clipboard
function copyToClipboard(elementId) {
  const element = document.getElementById(elementId);
  if (!element) return;
  
  let textToCopy = element.textContent;
  let fieldName = "Teks";

  // Untuk totalAmount, gunakan nilai bersih jika ada
  if (elementId === 'totalAmount' && element.hasAttribute('data-clean')) {
    textToCopy = element.getAttribute('data-clean');
  }
  
  // Tentukan nama field yang disalin
  switch(elementId) {
    case 'resultUserId': fieldName = "User ID"; break;
    case 'merchantName': fieldName = "Nama Merchant"; break;
    case 'totalAmount': fieldName = "Total Pembayaran"; break;
    case 'rrn': fieldName = "Nomor Referensi"; break;
    case 'selectedBank': fieldName = "Jenis Bank"; break;
  }

  navigator.clipboard.writeText(textToCopy).then(() => {
    // Tambahkan animasi ke tombol salin
    const copyButton = element.nextElementSibling;
    if (copyButton) {
      copyButton.classList.add('copy-success');
      setTimeout(() => {
        copyButton.classList.remove('copy-success');
      }, 500);
    }
    
    showNotification(`<strong>${fieldName}</strong> berhasil disalin!`);
  }).catch(err => {
    console.error('Gagal menyalin teks: ', err);
    // Fallback untuk browser lama
    const textarea = document.createElement('textarea');
    textarea.value = textToCopy;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showNotification(`<strong>${fieldName}</strong> berhasil disalin!`);
  });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  const imageUrlInput = document.getElementById('imageUrl');
  const userIdInput = document.getElementById('userId');
  const clearUserIdBtn = document.getElementById('clearUserId');
  const clearImageUrlBtn = document.getElementById('clearImageUrl');
  const processButton = document.getElementById('processButton');
  const resetButton = document.getElementById('resetButton');
  const uploadContainer = document.getElementById('uploadContainer');
  const fileInput = document.getElementById('fileInput');
  const themeToggle = document.getElementById('themeToggle');
  const previewContainer = document.getElementById('preview-container');
  const preview = document.getElementById('preview');
  const closePreview = document.getElementById('closePreview');
  
  // Clear user ID
  if (clearUserIdBtn) {
    clearUserIdBtn.addEventListener('click', function() {
      if (userIdInput) {
        userIdInput.value = '';
        userIdInput.focus();
      }
    });
  }
  
  // Clear image URL
  if (clearImageUrlBtn) {
    clearImageUrlBtn.addEventListener('click', function() {
      if (imageUrlInput) {
        imageUrlInput.value = '';
        imageUrlInput.focus();
      }
    });
  }
  
  // Proses gambar
  if (processButton) {
    processButton.addEventListener('click', function() {
      if (!isProcessing) {
        processImage();
      }
    });
  }
  
  // Reset form
  if (resetButton) {
    resetButton.addEventListener('click', function() {
      if (userIdInput) userIdInput.value = '';
      if (imageUrlInput) imageUrlInput.value = '';
      if (document.getElementById('bankSelect')) document.getElementById('bankSelect').selectedIndex = 0;
      if (previewContainer) previewContainer.style.display = 'none';
      if (document.getElementById('resultUserId')) document.getElementById('resultUserId').textContent = '-';
      if (document.getElementById('merchantName')) document.getElementById('merchantName').textContent = '-';
      if (document.getElementById('totalAmount')) document.getElementById('totalAmount').textContent = '-';
      if (document.getElementById('rrn')) document.getElementById('rrn').textContent = '-';
      if (document.getElementById('selectedBank')) document.getElementById('selectedBank').textContent = '-';
      uploadedImageUrl = null;
      currentImageUrl = null;
      if (fileInput) fileInput.value = '';
      
      // Sembunyikan modal jika sedang terbuka
      document.getElementById('imagePreviewModal').style.display = 'none';
    });
  }
  
  // Upload gambar
  if (uploadContainer && fileInput) {
    uploadContainer.addEventListener('click', function() {
      fileInput.click();
    });
    
    fileInput.addEventListener('change', function(e) {
      if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0];
        
        // Validasi ukuran file
        if (file.size > 5 * 1024 * 1024) {
          showNotification('Ukuran file terlalu besar. Maksimal 5MB', true);
          return;
        }
        
        const reader = new FileReader();
        
        reader.onload = function(event) {
          uploadedImageUrl = event.target.result;
          currentImageUrl = uploadedImageUrl; // Simpan untuk preview nanti
          
          // Tampilkan preview
          if (preview) {
            preview.src = uploadedImageUrl;
            previewContainer.style.display = 'block';
          }
        }
        
        reader.readAsDataURL(file);
      }
    });
  }
  
  // Toggle dark mode
  if (themeToggle) {
    themeToggle.addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
      
      if (document.body.classList.contains('dark-mode')) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        themeToggle.title = 'Mode Terang';
      } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        themeToggle.title = 'Mode Gelap';
      }
    });
  }
  
  // Update User ID secara real-time
  if (userIdInput) {
    userIdInput.addEventListener('input', function() {
      if (document.getElementById('resultUserId')) {
        document.getElementById('resultUserId').textContent = this.value || '-';
      }
    });
  }
  
  // Buka modal preview gambar saat klik pada gambar preview
  if (previewContainer) {
    previewContainer.addEventListener('click', function() {
      if (currentImageUrl) {
        document.getElementById('previewImage').src = currentImageUrl;
        document.getElementById('imagePreviewModal').style.display = 'block';
      }
    });
  }
  
  // Tutup modal preview gambar
  if (closePreview) {
    closePreview.addEventListener('click', function() {
      document.getElementById('imagePreviewModal').style.display = 'none';
    });
  }
  
  // Tutup modal jika klik di luar gambar
  window.addEventListener('click', function(event) {
    if (event.target === document.getElementById('imagePreviewModal')) {
      document.getElementById('imagePreviewModal').style.display = 'none';
    }
  });
  
  // Tutup modal dengan tombol ESC
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      document.getElementById('imagePreviewModal').style.display = 'none';
    }
  });
});
</script>
</body>
</html>
